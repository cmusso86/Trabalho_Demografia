---
titulo: "Trabalho Demografia"
subtitulo: "Santa Catarina"
aluno1:  "Carolina Musso 18/0047850"
aluno2: "Laura Teixeira 19/0016051"
aluno3: "Jéssica"
aluno4: "Leonardo"
orientador: "Ana Maria Nogales"
ano: "1/2023"
referencias: referencias.bib
output: 
  bookdown::pdf_document2:
    template: template.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
```

# Introdução

O estado brasileiro de Santa Catarina tem como capital a ilha de Floranópolis e está localizado no centro da região sul do país. O estado faz fronteira ao norte com o Paraná e ao sul pelo Rio Grande do Sul. É banhado ao leste pelo Oceano Atlântico e e ao oeste faz fronteira com a Argentina. Sua área abrange 95.736,165 km² (https://www.ibge.gov.br/cidades-e-estados) e possui uma população de mais de 6 milhões de habitantes , sendo o décimo estado mais populoso do Brasil (https://ftp.ibge.gov.br/Estimativas_de_Populacao/Estimativas_2021/estimativa_dou_2021.pdf). O estado possui 295 municípios, sendo Joinville, Florianópolis, Blumenau, Criciúma e Chapecó as principais cidades.

Santa Catarina possui índices sociais muito elevados em comparação com o restante do Brasil. É o estado com a maior expectativa de vida, empatando com o Distrito Federal. Além disso, possui a menor taxa de mortalidade infantil e é o estado com menor desigualdade econômica e analfabetismo no país. Em termos econômicos, Santa Catarina possui o sexto maior Produto Interno Bruto (PIB) do Brasil e o quarto maior PIB per capita, ficando atrás apenas do Distrito Federal, São Paulo e Mato Grosso. Sua economia é diversificada e tem uma forte ênfase na industrialização. O estado é um importante polo de exportação e consumo, sendo um dos maiores contribuintes para o crescimento da economia brasileira, representando 4% do PIB nacional (https://agenciadenoticias.ibge.gov.br/agencia-sala-de-imprensa/2013-agencia-de-noticias/releases/17999-contas-regionais-2015-queda-no-pib-atinge-todas-as-unidades-da-federacao-pela-primeira-vez-na-serie).

O tema desse trabalho é a dinâmica demográfica, com a análise de dois componentes: a natalidade/fecundidade e a mortalidade do estado de Santa Catarina. 

# Objetivos

- Aplicar os conceitos e técnicas para análise de componentes de natalidade,  fecundidade e mortalidade a dados reais do estado de Santa Catarina. 

- Aplicar os conceitos e técnicas para a análise das componentes natalidade e fecundidade e mortalidade a dados reais do estado de Santa Catarina.

- Avaliar a qualidade da informação dos Sistemas de Informação sobre Nascidos Vivos e Mortalidade do Ministério da Saúde para análise da fecundidade e mortalidade de Santa Catarina.

- Se familiarizar com os bancos de dados de nascidos vivos e óbitos do Ministério da Saúde.

# Desenvolvimento

## Questão 1: Diagrama de Lexis {-}

**a) Construir o Diagrama de Lexis para os dados de nascidos vivos de 2000 a 2021 da UF escolhida (SINASC) e de óbitos menores de 5 anos (idades simples) para o mesmo período segundo ano de nascimento.**

\begin{figure}[h!]
	\centering
	\caption{Diagrama de Lexis dos óbitos e nascimentos vivos de 2000 a 2021, Santa Catarina.}
		\includegraphics[scale = .9]{img/diaglexis_a.png}
	\label{fig:lexis}
\end{figure}


**b) Supondo população fechada (inexistência de migração), calcule a probabilidade de um recém-nascido na UF ou território de escolha sobreviver à idade exata 5 para as coortes de 2000 a 2016.**

**c) Considerando o mesmo pressuposto, calcule a probabilidade de sobreviver ao primeiro aniversário dos recém-nascidos no período de 2000 a 2020.**

**d) Comente sobre os valores encontrados. Não esquecer a qualidade da informação trabalhada.**

\newpage

## Questão 2: Natalidade/Fecundidade {-}

**a) Com base nos dados do SINASC para os de 2010, 2019 e  2021 e na população por sexo e idade estimada (projetada), construa os seguintes indicadores para a Unidade da Federação:**



### Taxa Bruta de Natalidade (TBN) {-}

```{r}
pacman::p_load(tidyverse, LexisPlotR, readxl, janitor, kableExtra, scales, reshape2, cowplot)
pacman::p_load_gh("danicat/read.dbc")

# Dados -------

arquivos_nasc <- str_c("Bases/", 
                  list.files(path="Bases/", pattern="^DNS"))

nascimentos <-  map_dfr(arquivos_nasc,~ read.dbc(.x)) %>% 
  mutate_all(~as.character(.))

obitos <- readRDS("Bases/dados_SIM.rds")


populacao <- read_excel("Bases/populacao_Sc.xls")


ibge_indicadores <- read_excel("Bases/indicadores_IBGE_SC.xlsx")

# Processamento dados -----


pop_grupos<- populacao %>% 
  select(IDADE, Sexo, "2010","2019", "2021" ) %>% 
  mutate(IDADE=str_replace(IDADE, "\\+", "")) %>% 
  mutate(IDADE=as.numeric(IDADE)) %>% 
  mutate(faixa=cut(IDADE, breaks=c(-1, 1, 5, 10, 15, 20,
                                   25, 30, 35, 40, 45, 50, 
                                   55, 60, 65, 70, 75, 80, 
                                   85,90,  200), 
                   labels=c("<1", "1-4", "5-9", "10-14", "15-19",
                            "20-24", "25-29", "30-34", "35-39", 
                            "40-44", "45-49", "50-54", "55-59",
                            "60-64", "65-69", "70-74", "75-79", 
                            "80-84", "85-89", ">90"), right=F)) %>% 
  pivot_longer(cols=c("2010", "2019", "2021"), names_to = "Ano", 
               values_to = "Pop") %>% 
  group_by(Ano, Sexo, faixa) %>% 
  summarise(Pop=sum(Pop)) %>% 
  pivot_wider(id_cols=c(Sexo, faixa), 
              names_from = Ano, values_from = Pop) 


# chequei só tem SC mesmo

nascimentos_trat <- nascimentos %>% 
  select(IDADEMAE, DTNASC, SEXO, DTNASCMAE) %>% 
  mutate(DTNASC=dmy(DTNASC),
         DTNASCMAE=dmy(DTNASCMAE),
         IDADEMAE=as.numeric(IDADEMAE)) %>% 
  mutate(Ano=as.character(year(DTNASC)),
         faixa=cut(IDADEMAE, breaks=c(-1, 1, 5, 10, 15, 20,
                                          25, 30, 35, 40, 45, 50, 
                                          55, 60, 65, 70, 75, 80, 
                                          85,90,  200), 
                   labels=c("<1", "1-4", "5-9", "10-14", "15-19",
                                   "20-24", "25-29", "30-34", "35-39", 
                                   "40-44", "45-49", "50-54", "55-59",
                                   "60-64", "65-69", "70-74", "75-79", 
                                   "80-84", "85-89", ">90"), right=F))
  
nascimentos_tot <- nascimentos_trat %>% 
  group_by(Ano) %>% 
  count(name="nasc")

TBN <-pop_grupos %>% 
  adorn_totals() %>% 
  filter(Sexo=="Total")%>% 
  select("2010", "2019", "2021") %>% 
  pivot_longer(everything(), names_to = "Ano",
               values_to = "Pop") %>% 
  left_join(nascimentos_tot) %>% 
  mutate(TBN = (nasc/Pop)*1000)


```

A TBN é uma medida da intensidade dos nacimentos em uma população. É uma das medidas mais simples de serem realizadas no que se refere a medida de nascimentos de uma população, uma vez que para seu cálculo são necessários apensas os valores de população residente e de nascimentos ocorridos em um período. É uma medida que pode ser muito influenciada pela estrutura etária de uma população bem como a razão de sexo. 

Pela tabela abaixo, podemos observar que a TBN do estado se manteve em torno de 13 nascimentos para cada mil habitantes, sendo que a taxa mais baixa foi observada em 2021. 

```{r}

caption1 <- "Taxa Bruta de Natalidade no estado de Santa Catarina, Brasil, nos anos de 2010, 2019 e 2021."

TBN %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".")) %>% 
  kable(format="latex",caption = caption1, booktabs = TRUE, linesep="", align=c("c", "r", "r", "r"), col.names=c("Ano", "População\nresidente", "Nascidos\nVivos", "TBN\n(mil hab.)"))  %>%
   kable_styling(latex_options="hold_position", position="center")
```

### Taxa Fecundidade Geral (TFG) {-}

A TFG ligeriamente mais refinada que o indicador anterior por acrescenta uma informação que a medida anterior não possúia, que é a relaÇão de nascimentos por mulheres em período. Entretanto, ainda há muita influência da estrutura etária, uma vez que a fecundidade feminina não é constante durante seu período fértil. 
Ta tabela abaixo podemos observar os resultados para os anos selecionados. Nesse caso o valor mais baixo foi observado em 2010 e o mais alto em 2019, e em 2021 o valor voltou a descrescer. 

```{r}
pop_fem_fertil <- pop_grupos %>% 
  filter(Sexo=="F", 
         faixa %in% c("15-19", "20-24", "25-29",
                      "30-34", "35-39", "40-44",
                      "45-49")) 

TFG <- pop_fem_fertil %>% 
  adorn_totals() %>% 
  filter(Sexo=="Total") %>% 
  select("2010", "2019", "2021") %>% 
  pivot_longer(everything(), names_to = "Ano",
               values_to = "Pop_fem") %>% 
  left_join(nascimentos_tot) %>% 
  mutate(TFG = nasc/Pop_fem*1000)

caption2 <- "Taxa de Fecundidade Geral por mil habitantes no estado de Santa Catarina, Brasil, nos anos de 2010, 2019 e 2021."

TFG %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".")) %>% 
  kable(format="latex",caption = caption2, booktabs = TRUE, linesep="", align=c("c", "r", "r", "r"), col.names=c("Ano", "População Feminina \nresidente", "Nascidos\nVivos", "TGF\n(mil hab.)"))  %>%
   kable_styling(latex_options="hold_position", position="center")
```


### Taxas específicas de fecundidade - nfx {-}


A medida de taxa específica acrescenta ainda a estratificação por faixa-etária. Nesse sentido, é uma medida que permite a comparação etre populações e ao longo do tempo. 

Abaixo podemos observar que para todos os anos, a idade mais prolífica foi entre 25-29 anos. Entretanto, observamos que para o ano de 2010 a fecundidade era mais equilibrada entre 20-24 e 25-29 anos, enquanto que para o ano de 2019 e 2022 houve relativamente taxas maiores em idades de 25-29 > 30 anos. 


```{r}
pop_fem_fertil_faixa <- pop_fem_fertil %>% 
  pivot_longer(c("2010", "2019", "2021"),
               names_to = "Ano", values_to = "Pop") 
 
nfx <- nascimentos_trat %>% 
  group_by(Ano, faixa) %>% 
  count(name = "nasc") %>% 
  right_join(pop_fem_fertil_faixa) %>% 
  mutate(nfx = nasc/Pop*1000) %>% 
  select(Ano, faixa, nfx) %>% 
  pivot_wider(id_cols = faixa, 
              names_from = Ano, 
              values_from = nfx) 


caption3 <- "Taxa de Fecundidade Específica por mil habitante no estado de Santa Catarina, Brasil, nos anos de 2010, 2019 e 2021."

nfx %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".", accuracy = .01)) %>%
  mutate(faixa=str_c(faixa,  " anos")) %>% 
  kable(format="latex",caption = caption3, booktabs = TRUE, linesep="", align=c("l", "r", "r", "r"), col.names=c("Faixa-Etária", "2010", "2019", "2021"))  %>%
   kable_styling(latex_options="hold_position", position="center") %>% 
  add_header_above(c(" ", "nfx (mil hab.)"=3))

```


Abaixo podemos observar o gráfico dessa dinâmica. No ano de 2010 foi mais comum a ocorrência de mães adolescentes. Nos anos de 2019 e 2021 houve um aumento na reprodução no estado, com aumento nos nascimentos para todas as outras faixas-estárias maternas. 

```{r}
nfx %>% 
  pivot_longer(-faixa, names_to = "Ano", values_to = "nfx") %>% 
  #mutate(faixa=as.numeric(str_sub(faixa, 1, 2))) %>% 
  ggplot(aes(x=factor(faixa), color=Ano, group=Ano))+
  geom_path(aes(y=nfx),)+
  geom_point(aes(y=nfx))+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1))+
  labs(x="Faixa-Etária", y= "Taxa Específica de Fecundidade")
```

### Taxa de Fecundidade Total {-}

A taxa de fecundidade total pode trazer informação sobre o potencial de crescimento de uma população. Em geral, valores acima de 2,1 indicam uma reposição positiva da população, com tendência de crescimento a longo prazo. Notamos que, pelo padrão abaixo, apesar de ter havido um aumento na reprodução nos últimos anos, esse valor se mantém abaixo do limiar considerado para reposição da população existente.

```{r}
TFT <- nfx %>% 
  pivot_longer(c("2010", "2019", "2021"),
               names_to = "Ano", values_to = "nfx") %>% 
  mutate(nfx_5=5*nfx/1000) %>% 
  select(-nfx) %>% 
  pivot_wider(id_cols = faixa, 
              names_from = Ano, 
              values_from = nfx_5) %>% 
  adorn_totals(name="TFT") %>% 
  filter(faixa=="TFT") %>% 
  pivot_longer(-faixa, names_to =  "Ano", values_to = "TFT") %>% 
  select(-faixa)

caption4 <- "Taxa de Fecundidade total no estado de Santa Catarina, Brasil, nos anos de 2010, 2019 e 2021."

TFT %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".", accuracy = .01)) %>%
  kable(format="latex",caption = caption4, booktabs = TRUE, linesep="", align=c("l", "r"), col.names=c("Ano", "TFT"))  %>%
   kable_styling(latex_options="hold_position", position="center") 
```


### Taxas específicas de fecundidade feminina {-}

As taxas específicas de fecundidade feminina já acrescentam a informação de reposição da população com indivíduos que, por sua vez, també, tâm a capacidade de se reproduzir. A estratificação por faixa-etária permite a comparação entre populações e ao longo do tempo, e também o cálculo do indicador que será apresentado no próximo tópico. 



```{r}
nffx <- nascimentos_trat %>% 
  filter(SEXO==2) %>% 
  group_by(Ano, faixa) %>% 
  count(name = "nasc") %>% 
  right_join(pop_fem_fertil_faixa) %>% 
  mutate(nffx = nasc/Pop*1000) %>% 
  select(Ano, faixa, nffx) %>% 
  pivot_wider(id_cols = faixa, 
              names_from = Ano, 
              values_from = nffx) 


caption5 <- "Taxas Específica de Fecundidade Feminina por mil habitante no estado de Santa Catarina, Brasil, nos anos de 2010, 2019 e 2021."

nffx %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".", accuracy = .01)) %>%
  mutate(faixa=str_c(faixa,  " anos")) %>% 
  kable(format="latex",caption = caption5, booktabs = TRUE, linesep="", align=c("l", "r", "r", "r"), col.names=c("Faixa-Etária", "2010", "2019", "2021"))  %>%
   kable_styling(latex_options="hold_position", position="center") %>% 
  add_header_above(c(" ", "nffx (mil hab.)"=3))
```


### Taxa Bruta de Reprodução {-}

A taxa bruta de repodução poderia ser equivalente a taxa de fecundidade total, mas dessa vez considerando apenas a populaÇão feminina.

```{r}
TBR <- nffx %>% 
  pivot_longer(c("2010", "2019", "2021"),
               names_to = "Ano", values_to = "nffx") %>% 
  mutate(nffx_5=5*nffx/1000) %>% 
  select(-nffx) %>% 
  pivot_wider(id_cols = faixa, 
              names_from = Ano, 
              values_from = nffx_5) %>% 
  adorn_totals(name="TBR") %>% 
  filter(faixa=="TBR") %>% 
  select(-faixa) %>% 
  pivot_longer(everything(), names_to = "Ano", values_to = "TBR")

caption6 <- "Taxa de Bruta de Reprodução no estado de Santa Catarina, Brasil, nos anos de 2010, 2019 e 2021."

TBR  %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".", accuracy = .01)) %>%
  kable(format="latex",caption = caption6, booktabs = TRUE, linesep="", align=c("l", "r"), col.names=c("Ano", "TBR"))  %>%
   kable_styling(latex_options="hold_position", position="center") 
```


### Taxa Líquida de Reprodução {-}

Finalmente, a taxa líquida de reprodução leva em consideração o risco de mortalidade em cada faixa-etária. 


**b) Compare os seus resultados com os valores obtidos  pelo IBGE (projeções), e para o Brasil, pelo estudo GBD, pelas Nações Unidas (UN Population) e aqueles publicados no site do Datasus para 2010 (RIPSA - Indicadores e dados básicos - http://tabnet.datasus.gov.br/cgi/idb2012/matriz.htm ). Como  os indicadores de reprodução não aparecem nessas listas, a partir das TFT, calcule esses indicadores para comparação.**

**c) Comente esses resultados (inclusive os gráficos das nfx), fazendo referência a artigos já publicados sobre o assunto.**


**d) Para os dados do SINASC para 2021, análise a associação entre (apresente ao menos uma medida de associação):**

idade e escolaridade da mãe 

tipo de parto e escolaridade da mãe
Apresente graficamente os dados e obtenha medidas para essa associação.

\newpage

## Questão 3: Mortalidade {-}

**a) Com base nos dados sobre óbitos do SIM para 2010, 2019 e 2021 e a população por sexo e idade estimada (projetada) para a UF, obtenha os seguintes indicadores:**

### Taxa Bruta de Mortalidade {-}

```{r}
# Dados -------

populacao <- read_excel("Bases/populacao_Sc.xls")
mortalidade <- readRDS("dados_SIM.rds")

# Letra a -------

# a) Com base nos dados sobre óbitos do SIM para 2010, 2019 e  2021 e a população
# por sexo e idade estimada (projetada) para a UF, obtenha os seguintes indicadores:

mortalidade$ano_obt <- str_sub(mortalidade$DTOBITO, 5,8)
# idade em anos (data obito - data nascimento)
mortalidade$data_obito <- lubridate::dmy(mortalidade$DTOBITO)
mortalidade$data_nasc <- lubridate::dmy(mortalidade$DTNASC)
mortalidade$idade <- (mortalidade$data_obito-mortalidade$data_nasc) #diferenca em dias
mortalidade$idade <- as.numeric((mortalidade$idade)/365)
mortalidade <- mortalidade %>% mutate(sexo = case_when(
  SEXO==1 ~ "M",
  SEXO==2 ~ "F",
  SEXO==9 ~ "Ignorado"
))

mort_anos_filtered <- mortalidade %>% filter(ano_obt %in% c("2010","2019","2021"))

pop_grupos <- populacao %>% 
  select(IDADE, Sexo, "2010","2019", "2021" ) %>% 
  mutate(IDADE=str_replace(IDADE, "\\+", "")) %>% 
  mutate(IDADE=as.numeric(IDADE)) %>% 
  mutate(faixa=cut(IDADE, breaks=c(-1, 1, 5, 10, 15, 20,
                                   25, 30, 35, 40, 45, 50, 
                                   55, 60, 65, 70, 75, 80, 
                                   85,90,  200), 
                   labels=c("<1", "1-4", "5-9", "10-14", "15-19",
                            "20-24", "25-29", "30-34", "35-39", 
                            "40-44", "45-49", "50-54", "55-59",
                            "60-64", "65-69", "70-74", "75-79", 
                            "80-84", "85-89", ">90"), right=F)) %>% 
  pivot_longer(cols=c("2010", "2019", "2021"), names_to = "Ano", 
               values_to = "Pop") %>% 
  group_by(Ano, Sexo, faixa) %>% 
  summarise(Pop=sum(Pop)) %>% 
  pivot_wider(id_cols=c(Sexo, faixa), 
              names_from = Ano, values_from = Pop) 


obitos_trat <- mort_anos_filtered %>% 
  select(data_obito, data_nasc, idade, ano_obt,sexo) %>% 
  mutate(faixa=cut(idade, breaks=c(-1, 1, 5, 10, 15, 20,
                                      25, 30, 35, 40, 45, 50, 
                                      55, 60, 65, 70, 75, 80, 
                                      85, 90,  200), 
                   labels=c("<1", "1-4", "5-9", "10-14", "15-19",
                            "20-24", "25-29", "30-34", "35-39", 
                            "40-44", "45-49", "50-54", "55-59",
                            "60-64", "65-69", "70-74", "75-79", 
                            "80-84", "85-89", ">90"), right=F))

  
## Taxa Bruta de Mortalidade (TBM) ----

obitos_tot <- obitos_trat %>% 
  group_by(ano_obt) %>% 
  count(name="obitos")
names(obitos_tot)[1] <- "Ano"

TBM <- pop_grupos %>% 
  adorn_totals() %>% 
  filter(Sexo=="Total") %>% 
  select("2010", "2019", "2021") %>% 
  pivot_longer(everything(), names_to = "Ano",
               values_to = "Pop") %>% 
  left_join(obitos_tot) %>% 
  mutate(TBM = obitos/Pop*1000)

TBM %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".")) %>%
  kable(format="latex",caption = "Taxas brutas de mortalidade por mil habitantes no estado de Santa Catarina, Brasil, nos anos
de 2010, 2019 e 2021.", booktabs = TRUE,
        linesep="", digits=2, align=c("r", "r", "r", "r"), col.names=c("Ano", "População", "Óbitos", "TBM (mil hab.)"))  %>%
   kable_styling(latex_options="hold_position", position="center")
```


### Taxas específicas de mortalidade por sexo e idade - nMx {-}

```{r}
## Taxas específicas de mortalidade por sexo e idade - nMx (grafique) ----

obitos_tot_idade_sexo <- obitos_trat %>% 
  filter(sexo %in% c("M","F")) %>%
  group_by(ano_obt,faixa,sexo) %>% 
  count(name="obitos")
names(obitos_tot_idade_sexo)[1] <- "Ano"

pop_desagrup <- melt(pop_grupos, c("Sexo","faixa"), value.name="populacao")
names(pop_desagrup)[3] <- "Ano"
names(pop_desagrup)[1] <- "sexo"

nMx <- obitos_tot_idade_sexo %>% 
  left_join(pop_desagrup,by=c("Ano","faixa","sexo")) %>% 
  mutate(nMx = obitos/populacao) %>% 
  filter(!is.na(faixa))

nMx$sexo <- factor(nMx$sexo, levels = c("M","F"),labels=c("Masculino","Feminino"))

plot2010 <- nMx %>% filter(Ano=="2010") %>%
ggplot(aes(x=faixa,y=nMx,group=sexo,colour=sexo))+
geom_line(size=1)+
  scale_y_log10()+
scale_colour_manual(name="Sexo",values=c("darkcyan",
"darkred"))+
labs(x="",y="nMx",title="2010")+
theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1))+
  theme(legend.position = 'top', legend.direction = "horizontal")

plot2019 <- nMx %>% filter(Ano=="2019") %>%
  ggplot(aes(x=faixa,y=nMx,group=sexo,colour=sexo))+
  geom_line(size=1)+
  scale_y_log10()+
  scale_colour_manual(name="Sexo",values=c("darkcyan",
                                           "darkred"))+
  labs(x="",y="nMx",title="2019")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1))+
  theme(legend.position = 'top', legend.direction = "horizontal")

plot2021 <- nMx %>% filter(Ano=="2021") %>%
  ggplot(aes(x=faixa,y=nMx,group=sexo,colour=sexo))+
  geom_line(size=1)+
  scale_y_log10()+
  scale_colour_manual(name="Sexo",values=c("darkcyan",
                                           "darkred"))+
  labs(x="",y="nMx",title="2021")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1))+
  theme(legend.position = 'top', legend.direction = "horizontal")


#cowplot::plot_grid(plot2010,plot2019,plot2021)
#ggsave('./img/TEM.png', width = 188, height = 113, units = 'mm',bg="white")
```

\begin{figure}[h!]
	\centering
	\caption{Taxas específicas de mortalidade por sexo e idade em Santa Catarina, Brasil, nos
anos de 2010, 2019 e 2021.}
		\includegraphics[scale = .9]{img/TEM.png}
	\label{fig:nMx}
\end{figure}


```{r}
# tabela nMx

tbl_nMx <- data.frame("faixa"=unique(nMx$faixa),"F2010"=nMx$nMx[(nMx$sexo=="Feminino" & nMx$Ano=="2010")]*1000,
                      "F2019"=nMx$nMx[(nMx$sexo=="Feminino" & nMx$Ano=="2019")]*1000,
                      "F2021"=nMx$nMx[(nMx$sexo=="Feminino" & nMx$Ano=="2021")]*1000,
                      "M2010"=nMx$nMx[(nMx$sexo=="Masculino" & nMx$Ano=="2010")]*1000,
                      "M2019"=nMx$nMx[(nMx$sexo=="Masculino" & nMx$Ano=="2019")]*1000,
                      "M2021"=nMx$nMx[(nMx$sexo=="Masculino" & nMx$Ano=="2021")]*1000
                      )

tbl_nMx$faixa <- str_c(tbl_nMx$faixa,  " anos")
tbl_nMx$faixa[1] <- "$<$ 1 anos"
tbl_nMx$faixa[20] <- "$>$ 90 anos"

captionNMX <- "Taxas específicas de mortalidade por mil habitantes no estado de Santa Catarina, Brasil, nos anos
de 2010, 2019 e 2021."

tbl_nMx %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".")) %>%
  kable(escape = F,format="latex",caption = captionNMX, booktabs = TRUE, linesep="", digits=2,
        align=c("l", "r", "r", "r", "r", "r", "r"), col.names=c("Faixa-Etária", "2010", "2019", "2021", "2010", "2019", "2021"))  %>%
   kable_styling(latex_options="hold_position", position="center") %>% 
  add_header_above(c(" ", "nMx feminina" = 3, "nMx masculina" = 3))

```

**b) Calcule a TMI, utilizando o número médio de óbitos ocorridos entre 2019 e 2021 e o número de nascimentos de 2020. Calcule os indicadores: taxa de mortalidade neonatal, neonatal precoce, neonatal tardia, posneonatal. Agregando a informação sobre óbitos fetais para os mesmos anos, calcule a taxa de mortalidade perinatal.**

```{r}
# Letra b -------
nasc_2020 <- 97916 # vem dos arquivos do SINASC
mortalidade$idade_dias <- mortalidade$idade*365

## TMI (óbitos em menores de 1 ano)

# nº medio de obitos de menores de 1 ano

obitos_1_ano <- mortalidade %>% filter(ano_obt %in% c("2019","2020","2021")) %>%
  filter(idade_dias<365) %>% group_by(ano_obt) %>%
  summarise(obitos=n())

media_obt_1_ano <- mean(obitos_1_ano$obitos)

q10 <- media_obt_1_ano/nasc_2020*1000

## Mortalidade Neonatal (Risco de um recém-nascido morrer antes de 28 dias de vida)

obitos_neonatal <- mortalidade %>% filter(ano_obt %in% c("2019","2020","2021")) %>%
  filter(idade_dias<28) %>% group_by(ano_obt) %>%
  summarise(obitos=n())

media_obt_neonatal <- mean(obitos_neonatal$obitos)

Mneonatal <- media_obt_neonatal/nasc_2020*1000

## Mortalidade Posneonatal (Risco de um recém-nascido morrer entre 28 e 364 dias de vida)

obitos_posneonatal <- mortalidade %>% filter(ano_obt %in% c("2019","2020","2021")) %>%
  filter(idade_dias>=28 & idade_dias<365) %>% group_by(ano_obt) %>%
  summarise(obitos=n())

media_obt_posneonatal <- mean(obitos_posneonatal$obitos)

Mposneonatal <- media_obt_posneonatal/nasc_2020*1000

## Mortalidade Precoce (Risco de um recém-nascido morrer antes de 7 dias de vida)

obitos_precoce <- mortalidade %>% filter(ano_obt %in% c("2019","2020","2021")) %>%
  filter(idade_dias<7) %>% group_by(ano_obt) %>%
  summarise(obitos=n())

media_obt_precoce <- mean(obitos_precoce$obitos)

Mprecoce <- media_obt_precoce/nasc_2020*1000

## Mortalidade Tardia (Risco de um recém-nascido morrer entre 7 e 27 dias de vida)

obitos_tardia <- mortalidade %>% filter(ano_obt %in% c("2019","2020","2021")) %>%
  filter(idade_dias>=7 & idade_dias<27) %>% group_by(ano_obt) %>%
  summarise(obitos=n())

media_obt_tardia <- mean(obitos_tardia$obitos)

Mtardia <- media_obt_tardia/nasc_2020*1000


## Taxa de Mortalidade Perinatal

obitos_fetais <- data.frame("Ano"= 2019:2021,"Obt_fetal" = c(810,765,771)) #consultado no TabNet SIM
media_obt_fetal <- mean(obitos_fetais$Obt_fetal)

TMPerinatal <- (media_obt_precoce+media_obt_fetal)/(nasc_2020+media_obt_fetal)*1000

# tabela mortalidade infantis
tipos <- c("Infantil","Neonatal","Posneonatal","Neonatal precoce","Neonatal tardia","Perinatal")
tbl_mort_infantil <- data.frame("Taxa de mortalidade"=tipos,
                                "Valor (mil hab.)"=c(q10,Mneonatal,Mposneonatal,
                                                     Mprecoce,Mtardia,TMPerinatal),
                                check.names = F)

tbl_mort_infantil %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".")) %>%
  kable(format="latex",caption = "Componentes da mortalidade infantil por mil habitantes no estado de Santa Catarina, Brasil, utilizando o número médio de óbitos entre 2019 e 2021 e o número de nascimentos de 2020.", booktabs = TRUE, linesep="", digits=2,
        align=c("l", "r"))  %>%
   kable_styling(latex_options="hold_position", position="center")
```


**c) Compare os seus resultados com os valores obtidos pelo estudo GBD, pela Nações Unidas (UN Population) e aqueles publicados no site do Datasus (RIPSA - Indicadores e dados básicos - http://tabnet.datasus.gov.br/cgi/idb2012/matriz.htm ). Para a TMI, compare com os valores obtidos na questão 1. Comente sobre os aspectos metodológicos dessas duas formas de cálculo.**


**d) Compare a estrutura de mortalidade por causas entre 2010 e 2021. Utilize 20 primeiras grupos de causas segundo Grupos CID-10 (ver Tabnet - Datasus), segundo sexo para os anos selecionado. Comente os resultados. Destacar a mortalidade por Covid-19 (CID B34.2). **


```{r}
# Letra d -------
obts_causas <- mortalidade %>% filter(ano_obt %in% c("2010","2021")) %>%
  select(CAUSABAS,ano_obt,sexo) %>%
  filter(sexo %in% c("M","F"))

obts_causas_top_20 <- obts_causas %>% group_by(ano_obt,sexo,CAUSABAS) %>%
  summarise(causas_count = n()) %>% ungroup() %>%
  group_by(ano_obt,sexo) %>%
  arrange(desc(causas_count),.by_group = TRUE) %>%
  slice_head(n=20)

# conferindo oq é cada código da CID

CID <- data.frame("CAUSABAS"=unique(obts_causas_top_20$CAUSABAS),
                  "significado"=c("Infarto agudo do miocárdio não especificado",
                                  "Acidente vascular cerebral, não especificado como hemorrágico ou isquêmico",
                                  "Diabetes mellitus não especificado - sem complicações",
                                  "Pneumonia não especificada",
                                  "Neoplasia maligna da mama, não especificada",
                                  "Hipertensão essencial (primária)",
                                  "Doença pulmonar obstrutiva crônica não especificada",
                                  "Neoplasia maligna dos brônquios ou pulmões, não especificado",
                                  "Outras causas mal definidas e as não especificadas de mortalidade",
                                  "Insuficiência cardíaca congestiva",
                                  "Insuficiência cardíaca não especificada",
                                  "Outras doenças cerebrovasculares especificadas",
                                  "Doença cardíaca hipertensiva com insuficiência cardíaca (congestiva)",
                                  "Doença de Alzheimer não especificada",
                                  "Septicemia não especificada",
                                  "Doença pulmonar obstrutiva crônica com infecção respiratória aguda do trato respiratório inferior",
                                  "Morte sem assistência",
                                  "Neoplasia maligna do estômago, não especificado",
                                  "Infecção do trato urinário de localização não especificada",
                                  "Hemorragia intracerebral não especificada",
                                  "Neoplasia maligna da próstata",
                                  "Neoplasia maligna do esôfago, não especificado",
                                  "Lesão autoprovocada intencionalmente por enforcamento, estrangulamento e sufocação",
                                  "Outras formas de cirrose hepática e as não especificadas",
                                  "Cirrose hepática alcoólica",
                                  "Pessoa traumatizada em um acidente de trânsito com um veículo a motor não especificado",
                                  "Infecção por coronavírus de localização não especificada",
                                  "Pneumonia bacteriana não especificada",
                                  "Sequelas de acidente vascular cerebral não especificado como hemorrágico ou isquêmico"))

obts_causas_top_20 <- left_join(obts_causas_top_20, CID, by="CAUSABAS") 

# tabela para os anos de 2010 e 2021 FEMININO

df_mulheres <- obts_causas_top_20 %>% filter(sexo=="F")

tbl_mulheres <- data.frame("significado"= df_mulheres$significado[1:20],
                           "2010" = df_mulheres$causas_count[1:20],
                           check.names = F) %>%
            left_join(.,df_mulheres[21:40,c("causas_count","significado")],
            by="significado")

names(tbl_mulheres)[3] <- "2021"

tbl_mulheres <- rbind(tbl_mulheres, data.frame(significado=df_mulheres$significado[21],"2010"="-",
                                               "2021"=df_mulheres$causas_count[21],check.names = F))

tbl_mulheres <- rbind(tbl_mulheres, data.frame(significado=df_mulheres$significado[37],"2010"="-",
                                               "2021"=df_mulheres$causas_count[37],check.names = F))

tbl_mulheres$`2021`[is.na(tbl_mulheres$`2021`)] <- "-"
names(tbl_mulheres)[1] <- "Causa básica da DO"

tbl_mulheres %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".")) %>%
  kable(format="latex",caption = "Estrutura de mortalidade por causas de 2010 e 2021 para o sexo feminino.", booktabs = T, linesep="", digits=2,
        align=c('l','r','r'))  %>%
   kable_styling(latex_options=c("HOLD_position","scale_down"), position="center")

```

```{r}
# tabela para os anos de 2010 e 2021 MASCULINO

df_homens <- obts_causas_top_20 %>% filter(sexo=="M")

tbl_homens <- data.frame("significado"= df_homens$significado[1:20],
                           "2010" = df_homens$causas_count[1:20],
                           check.names = F) %>%
  left_join(.,df_homens[21:40,c("causas_count","significado")],
            by="significado")

names(tbl_homens)[3] <- "2021"

#causas de 2021 que nao estavam em 2010
tbl_homens <- rbind(tbl_homens, data.frame(significado=df_homens$significado[21],"2010"="-",
                                               "2021"=df_homens$causas_count[21],check.names = F))

tbl_homens <- rbind(tbl_homens, data.frame(significado=df_homens$significado[33:34],"2010"="-",
                                               "2021"=df_homens$causas_count[33:34],check.names = F))

tbl_homens <- rbind(tbl_homens, data.frame(significado=df_homens$significado[38:39],"2010"="-",
                                           "2021"=df_homens$causas_count[38:39],check.names = F))

tbl_homens$`2021`[is.na(tbl_homens$`2021`)] <- "-"
names(tbl_homens)[1] <- "Causa básica da DO"

tbl_homens %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".")) %>%
  kable(format="latex",caption = "Estrutura de mortalidade por causas de 2010 e 2021 para o sexo masculino.", booktabs = T, linesep="", digits=2,
        align=c('l','r','r'))  %>%
   kable_styling(latex_options=c("HOLD_position","scale_down"), position="center")
```


