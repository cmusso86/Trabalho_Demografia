---
titulo: "Estrutura da População e Projeções"
subtitulo: "Santa Catarina"
aluno1:  "Carolina Musso 18/0047850"
aluno2: "Jéssica Vasconcelos 18/0048708"
aluno3: "Laura Teixeira 19/0016051"
aluno4: "Leonardo dos Reis Andrade 21/1029030"
orientador: "Ana Maria Nogales"
ano: "1/2023"
referencias: referencias.bib
output: 
  bookdown::pdf_document2:
    template: template.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
```

```{r bibliotecas}
# Carregando bibliotecas ---------

pacman::p_load(foreign,tidyverse, LexisPlotR, readxl, janitor, kableExtra, scales, reshape2, cowplot, ggmosaic, gplots, corrplot, DescTools,RColorBrewer, rio, apyramid,
               patchwork)

pacman::p_load_gh("danicat/read.dbc")

```

```{r bases}
# BASES ----

pop_censos <- import("./populacao_91_00_10.xlsx")
pop_proj <- import("./populacao_15_20_30.xlsx")
```

# Introdução

O estado brasileiro de Santa Catarina tem como capital a ilha de Floranópolis e está localizado no centro da região sul do país. O estado faz fronteira ao norte com o Paraná e ao sul pelo Rio Grande do Sul. É banhado ao leste pelo Oceano Atlântico e e ao oeste faz fronteira com a Argentina. Sua área abrange 95.736,165 km² e possui uma população de mais de 6 milhões de habitantes, sendo o décimo estado mais populoso do Brasil. O estado possui 295 municípios, sendo Joinville, Florianópolis, Blumenau, Criciúma e Chapecó as principais cidades \cite{IBGE}.

Santa Catarina possui índices sociais muito elevados em comparação com o restante do Brasil. É o estado com a maior expectativa de vida, empatando com o Distrito Federal. Além disso, possui a menor taxa de mortalidade infantil e é o estado com menor desigualdade econômica e analfabetismo no país. Em termos econômicos, Santa Catarina possui o sexto maior Produto Interno Bruto (PIB) do Brasil e o quarto maior PIB per capita, ficando atrás apenas do Distrito Federal, São Paulo e Mato Grosso. Sua economia é diversificada e tem uma forte ênfase na industrialização. O estado é um importante polo de exportação e consumo, sendo um dos maiores contribuintes para o crescimento da economia brasileira, representando 4% do PIB nacional \cite{IBGE2}.

INLCUIR INFORMACOES SOBRE A ESTRYTURA DA POPULACAO DE SC

Santa Catarina também enfrenta um processo de envelhecimento da população, um fenômeno observado no Brasil e em muitos países ao redor do mundo. A proporção de idosos vem aumentando significativamente nas últimas décadas, devido a fatores como avanços na área da saúde, melhorias nas condições de vida e diminuição da taxa de natalidade.

Esse envelhecimento populacional tem impactos em diversos aspectos da sociedade catarinense. O aumento da expectativa de vida e a diminuição da taxa de natalidade resultam em um crescimento relativo da população idosa em comparação com a população jovem. Isso traz desafios e oportunidades para o estado, incluindo questões relacionadas à saúde, previdência, políticas públicas e inclusão social.

O tema desse trabalho é o estudo da dinâmica e estrutura demográfica do estado de Santa Catarina por meio de pirâmides etárias, indicadores relacionados e a projeção de sua população.


# Desenvolvimento

## Parte 1 - Estrutura Populacional e avaliação da informação sobre idade

**a) Construa as pirâmides etárias por grupos de idade para a população da UF escolhida em 1991, 2000, 2010, 2015, 2020 e 2030 (obtenha os dados no portal do Datasus para os anos censitários e projeções para os demais anos). Comente os resultados à luz da discussão sobre transição demográfica.**


```{r}
fx1 <- c("Menor 1 ano", "1 ano", "2 anos", "3 anos", "4 anos")
fx2 <- c( "5 anos", "6 anos", "7 anos", "8 anos", "9 anos")
fx3 <- c( "10 anos", "11 anos", "12 anos", "13 anos", "14 anos")
fx4 <- c( "15 anos", "16 anos", "17 anos", "18 anos", "19 anos")

pop_censo_trat <- pop_censos %>% 
  mutate(faixa=case_when(Idade %in% fx1 ~ "0-4",
                   Idade %in% fx2 ~ "5-9",
                   Idade %in% fx3 ~ "10-14",
                   Idade %in% fx4 ~ "15-19",
                   .default = Idade)) %>% 
  pivot_longer(-c(Idade, faixa, sexo), names_to = "Ano", values_to = "Pop") %>% 
  mutate(faixa=str_replace(faixa, " a ", "-"),
         faixa=str_replace(faixa, " anos", ""),
         faixa=str_replace(faixa, "80 e mais", "80-")) %>% 
  select(-Idade) 

pop_proj_trat <- pop_proj %>% 
  mutate(faixa=cut(idade, breaks = c(-1, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 1000 ), labels = c("0-4","5-9","10-14","15-19","20-24" ,"25-29" ,"30-34","35-39","40-44" ,"45-49" ,"50-54" ,"55-59","60-64" ,"65-69" ,"70-74","75-79" ,"80-"), include.lowest = T, right = F)) %>% 
  select(-idade) %>% 
pivot_longer(-c(faixa, sexo), names_to = "Ano", values_to = "Pop") 


pop_completo <-pop_censo_trat  %>% 
  full_join(pop_proj_trat) %>% 
  mutate(faixa=factor(faixa,levels=c("0-4","5-9","10-14","15-19","20-24" ,"25-29" ,"30-34","35-39","40-44" ,"45-49" ,"50-54" ,"55-59","60-64" ,"65-69" ,"70-74","75-79" ,"80-"))) %>% 
  group_by(Ano,faixa, sexo) %>% 
  summarize(Pop=sum(Pop))
  
```

```{r fig.align='center'}

piramides <- list()


for (i in c("1991", "2000", "2010", "2015", "2020", "2030")){
  
 filtro <-pop_completo %>% 
  filter(Ano==i) %>% 
  mutate(pop=Pop/1000) 
#  
xlabels <- as.character(sort(unique(filtro$faixa)))
xlabels[seq(2, length(xlabels), 2)] <- ""
piramides[[i]] <- filtro %>% 
  apyramid::age_pyramid(age_group = "faixa",
                      split_by = "sexo",
                      count = "pop",
                      show_midpoint = FALSE) +
  theme_classic(base_size = 9)+
 scale_x_discrete(labels = xlabels)+
  theme(legend.position = "none", 
       axis.text.x =element_text(angle = 45, hjust=1))+
  labs(y="mil", x="")+
  ggtitle(i)
}

(piramides[[1]] + piramides[[2]]  )/(piramides[[3]] + piramides[[4]]  )/(piramides[[5]] + piramides[[6]]  )

```


**b) Para todos os anos acima mencionados, calcule os indicadores de estrutura por idade (proporção de idosos (60 anos e mais), proporção de crianças (0 a 4 anos), proporção de jovens (0 a 14 anos), razão de dependência e índice de envelhecimento). Calcule a idade média e a idade mediana. Calcule e grafique a razão de sexo por grupos de idade para 2000, 2010 e 2030. Comente os resultados.**


```{r}

idoso <- c("60-64", "65-69", "70-74", "75-79", "80-")

idosos <- pop_completo %>% 
  group_by(Ano, faixa) %>% 
  summarise(Pop=sum(Pop)) %>% 
  mutate(idosos=ifelse(faixa %in% idoso, 1, 0)) %>% 
  group_by(Ano) %>% 
  mutate(pop_tot=sum(Pop))%>% 
  ungroup() %>% 
  group_by(Ano, idosos) %>% 
  summarise(pop_tot=max(pop_tot),
            pop_idoso=sum(Pop)) %>% 
  filter(idosos==1) %>% 
  mutate(prop_idoso=pop_idoso/pop_tot*100) %>% 
  select(Ano, prop_idoso)



criancas <- pop_completo %>% 
  group_by(Ano, faixa) %>% 
  summarise(Pop=sum(Pop)) %>% 
  mutate(crianca=ifelse(faixa %in% "0-4", 1, 0)) %>% 
  group_by(Ano) %>% 
  mutate(pop_tot=sum(Pop))%>% 
  ungroup() %>% 
  group_by(Ano, crianca) %>% 
  summarise(pop_tot=max(pop_tot),
            pop_crianca=sum(Pop)) %>% 
  filter(crianca==1) %>% 
  mutate(prop_crianca=pop_crianca/pop_tot*100) %>% 
  select(Ano, prop_crianca)


jovens <- pop_completo %>% 
  group_by(Ano, faixa) %>% 
  summarise(Pop=sum(Pop)) %>% 
  mutate(jovens=ifelse(faixa %in% c("0-4", "5-9", "10-14"), 1, 0)) %>% 
  group_by(Ano) %>% 
  mutate(pop_tot=sum(Pop))%>% 
  ungroup() %>% 
  group_by(Ano, jovens) %>% 
  summarise(pop_tot=max(pop_tot),
            pop_jovens=sum(Pop)) %>% 
  filter(jovens==1) %>% 
  mutate(prop_jovens=pop_jovens/pop_tot*100) %>% 
  select(Ano, prop_jovens)

  
proporcoes <- criancas %>% 
  left_join(jovens) %>% 
  left_join(idosos) %>% 
  rowwise() %>% 
  mutate(inativos=prop_jovens + prop_idoso,
         ativos=100-inativos,
         RD=inativos/ativos, 
         IE=prop_idoso/prop_jovens*100)

titulo <- "Proporções e Indicadores"

proporcoes  %>% 
  select(Ano, prop_crianca, prop_jovens, prop_idoso, RD, IE) %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", accuracy=.01)) %>% 
  kable(format="latex", caption=titulo, booktabs = T, 
        linesep="", 
        align=c("c",rep("r",5)),
        col.names=c("Ano","Crianças (%)", "Jovens (%)", "Idosos (%)", "Razão de Dependência", "Índice de Envelhecimento")) %>% 
  kable_styling(latex_options = "hold_position", position="center", full_width = F)%>%  
   column_spec(2:6, width = "6em") %>% 
  footnote(general=c("Elaboração própria", "Censo 1991, 2000, 2010 (DataSus)", "Projeções 2015, 2020 e 2030 (IBGE)"),  escape=T,  footnote_as_chunk=F, general_title ="", fixed_small_size = T) 

```


Para os dados agrupados foi utilizado o ponto médio de cada classe de idade, sendo que para a classe de >80 foi utilizado o valor de 82,5 anos. A mediana foi calculada escolhedno o ponto médio da classe a partir da qual se acumulou 50% da populaçao daquele ano. 


```{r}
# medianas ----

idade_media <- pop_completo %>% 
  group_by(Ano, faixa) %>% 
  summarise(pop_faixa=sum(Pop)) %>% 
  ungroup() %>% 
  group_by(Ano) %>% 
  mutate(pop_tot=sum(pop_faixa),
         prop=pop_faixa/pop_tot) %>% 
  separate(faixa, c("inf", "sup"), remove=F) %>% 
  mutate_at(c("inf", "sup"), ~as.numeric(.)) %>% 
  mutate(ponto_medio=inf+2.5,
         fator = ponto_medio * prop ) %>% 
  group_by(Ano) %>% 
  summarise(idade_media=round(sum(fator),1))

idade_mediana_aux <- pop_completo %>% 
  group_by(Ano, faixa) %>% 
  summarise(pop_faixa=sum(Pop)) %>% 
  ungroup() %>% 
  group_by(Ano) %>% 
  mutate(pop_tot=sum(pop_faixa),
         acumulado=cumsum(pop_faixa),
         acum_rel = acumulado/pop_tot,
         metade=pop_tot/2,
         menor=metade>=acumulado,
         f_mediana=pop_faixa/pop_tot) 

idade_mediana_sup <- idade_mediana_aux %>% 
  filter(menor==F) %>% 
  group_by(Ano) %>% 
  arrange(faixa, .by_group = T)%>% 
  slice(1) 


idade_mediana_inf <- idade_mediana_aux %>% 
  filter(menor==T) %>% 
  group_by(Ano) %>% 
  arrange(desc(faixa), .by_group = T)%>% 
  slice(1) 


mediana_junto <-  idade_mediana_inf %>% 
  bind_rows(idade_mediana_sup) %>% 
  arrange(Ano) %>% 
  mutate(infe=as.numeric(str_sub(faixa, 1, 2))) %>%
  select(Ano, faixa, acum_rel, menor, f_mediana, infe) %>%
  mutate(mediana=(infe+ ((50-lag(acum_rel*100))/(f_mediana*100))*5))


idade_media_mediana <-mediana_junto %>% 
  filter(menor==F) %>% 
  select(Ano, mediana) %>% 
  left_join(idade_media)


titulo <- "Idade e média e mediana"
idade_media_mediana %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", accuracy=.1)) %>% 
  kable(format="latex", caption=titulo, booktabs = T, 
        linesep="", 
        align=c("c","r", "r"),
        col.names=c("Ano","Mediana (anos)", "Média (anos)")) %>% 
  kable_styling(latex_options = "hold_position", position="center", full_width = F) %>%  
   column_spec(1:3, width = "5em") %>% 
  footnote(general=c("Elaboração própria", "Censo 1991, 2000, 2010 (DataSus)", "Projeções 2015, 2020 e 2030 (IBGE)"),  escape=T,  footnote_as_chunk=F, general_title ="", fixed_small_size = T) 



```


Razao de sexo

Os homens morrem mais cedo.

```{r}
pop_completo %>% 
  pivot_wider(id_cols = c("Ano", "faixa"),
              names_from = sexo, values_from = Pop) %>% 
  mutate(RS=m/f*100) %>% 
  ggplot(aes(x=factor(faixa), color=Ano, group=Ano))+
  geom_point(aes(y=RS))+
  geom_line(aes(y=RS))+
  facet_wrap(~Ano)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  labs(x="Faixa Etária", y="Homens por 100 mulheres")

```



**c) Avalie a qualidade da declaração de idade no Censo 2010 segundo forma de declaração (data de nascimento e idade presumida). Calcule os índices de Whipple, Myers e Bachi.Construa a pirâmide por idade simples. Comente os resultados. (utilize a planilha SINGAGE do PAS - disponível na plataforma). Obtenha os dados na Tabela 3.2.1.2 do Censo 2010 - Resultados do Universo  (https://www.ibge.gov.br/estatisticas/sociais/populacao/9662-censo-demografico-2010.html?edicao=10503&t=downloads)**

Na Tabela a seguir foram calculados os índices para avaliação da declaração de idade por forma de declaração: data de nascimento, idade presumida e os resultados gerais, que são a junção de todos os tipos de declaração. Além disso, os resultados estão discriminados por sexo.


```{r}
### Tabela com índices de Whipple, Myers e Bachi (calculado na planilha SINGAGE)

quali_dados <- data.frame("Sexo"=c("Homem","Mulher","Total"),
                          "Whipple"=c(1.02,1.02,1.02)*100,
                          "Myers"=c(1,1.2,1.1),
                          "Bachi"=c(0.7,0.7,0.7),
                          "Whipple2"=c(1.25,1.22,1.24)*100,
                          "Myers2"=c(11.7,10.7,11.2),
                          "Bachi2"=c(7.3,6.6,6.9),
                          "Whipple3"=c(1.03,1.02,1.03)*100,
                          "Myers3"=c(1.1,1.2,1.2),
                          "Bachi3"=c(0.8,0.7,0.7))

quali_dados %>% 
  mutate_if(is.numeric, ~comma(., decimal.mark = ",", big.mark = ".")) %>%
  kable(escape = F,format="latex",caption = "Índices de Whipple, Myers e Bachi por tipo de declaração da idade, Censo 2010, Santa Catarina", booktabs = TRUE, linesep="", digits=2,
        align=c("l",rep("r",9)), col.names=c("Sexo",rep(c("Whipple","Myers","Bachi"),3)))  %>%
   kable_styling(latex_options="HOLD_position", position="center") %>% 
  add_header_above(c(" ", "Data de nascimento" = 3, "Idade presumida" = 3, "Geral" = 3))

```

Nota-se que, para a declaração por meio da data de nascimento, todos os índices revelam que os dados de idade são muito precisos, em ambos os sexos. O resultado é esperado, dado que a declaração por meio da data de nascimento é menos suscetível a erros e atração por dígitos. Nesse sentido, a idade presumida é muito mais suscetível a inconsistências.

De fato, o índice de Whipple expressa que os dados de idade presumida possuem atração pelos dígitos 0 e 5,  indicando que os dados são aproximados para ambos os sexos. Já os índices de Myers e Bachi medem a preferência (rejeição) por cada dígito. Novamente, para idade presumida eles indicam que os dados são imprecisos. Dessa forma, é necessário cautela ao utilizar tais dados.

Por último, unindo todas as declarações de idade, observa-se que os índices possuem bons valores, indicando que não há forte preferência por algum dígito. Isso se deve ao fato de apenas 147.106 indivíduos não terem declarado sua idade por meio da data de nascimento, de um total de 6.248.436 (ou seja, apenas 2,35%). Em suma, os dados gerais de idade apresentam boa qualidade.


```{r}
### Piramide por idade simples

pop_2010_censo <- import("./Tabela_censo_2010_resumida.xls")
pop_2010_censo <-  melt(pop_2010_censo,c("Idade","Total"))  
pop_2010_censo$Idade <- factor(pop_2010_censo$Idade,
                               levels=unique(pop_2010_censo$Idade))

pop_2010_censo$value <- pop_2010_censo$value/1000


labels_idade_simples <- c(as.character(0:99),"100+") 
labels <- labels_idade_simples[seq(1,102,by=5)]
breaks <- pop_2010_censo$Idade[seq(1,102,by=5)]

age_pyramid(pop_2010_censo, age_group = Idade, split_by = variable,
            count = value,show_midpoint = F) +
  theme_classic(base_size = 10)+
 scale_x_discrete(labels=labels,breaks=breaks)+
  theme(
       axis.text.x =element_text(angle = 45, hjust=1))+
  labs(y="mil", x="",fill="")

```

A pirâmide por idade simples, com dados do Censo de 2010, para Santa Catarina não parece revelar forte atração por idades terminadas em 0 ou 5 (ou algum outro dígito em especial). Tal observação corrobora as análises feitas com base nos índices de qualidade vistos anteriormente.

## Parte 2 - Projeção de População

**a) Com base na publicação 'Projeções da população : Brasil e unidades da federação : revisão 2018" disponível no link: https://biblioteca.ibge.gov.br/visualizacao/livros/liv101597.pdf e na publicação "ESTIMATIVAS DA POPULAÇÃO RESIDENTE PARA OS MUNICÍPIOS E PARA AS UNIDADES DA FEDERAÇÃO COM DATA DE REFERÊNCIA EM 1º DE JULHO DE 2021 " disponível no link:  https://biblioteca.ibge.gov.br/visualizacao/livros/liv101849.pdf.**

**Comente sobre:**

Metodologia utilizada para projetar a população do país segundo UF.
Metodologia para estimar populações dos municípios brasileiros


**b) Assumindo população fechada (ausência de migração), projete a população da UF escolhida de 2010 a 2020, segundo o cenário de mortalidade e fecundidade constante . Obtenha indicadores de fecundidade e mortalidade para o período 2014-2016 (nascimentos e óbitos médios do triênio e população projetada pelo IBGE para 2015) . Construa uma tábua de vida e obtenha as taxas específicas de fecundidade.**

```{r}

# PROJECOES IBGE #

projecao_2015 <- read_delim("~/UnB/2023/2023.1/Demografia_Ana Maria/Trabalho 2 - Projeção/projecao_2015.csv", 
                            delim = ";", escape_double = FALSE, trim_ws = TRUE)

projecao_2020 <- read_delim("~/UnB/2023/2023.1/Demografia_Ana Maria/Trabalho 2 - Projeção/projecao_2020.csv", 
                            delim = ";", escape_double = FALSE, locale = locale(), 
                            trim_ws = TRUE)

projecao_2030 <- read_delim("~/UnB/2023/2023.1/Demografia_Ana Maria/Trabalho 2 - Projeção/projecao_2030.csv", 
                            delim = ";", escape_double = FALSE, trim_ws = TRUE)

censo_2010 <- read_delim("~/UnB/2023/2023.1/Demografia_Ana Maria/Trabalho 2 - Projeção/censo_2010.csv", 
                            delim = ";", escape_double = FALSE, trim_ws = TRUE)

```


```{r}

#########################
#### ARRUMANDO DADOS ####
#########################

censo_2010 <- censo_2010 %>% 
  rename(faixa_etaria = "Faixa Etária detalhada") %>%
  mutate(faixa_etaria = str_replace_all(faixa_etaria,"ano(s)?",""),
         faixa_etaria = str_trim(str_replace_all(faixa_etaria,"Menor 1 ","0")),
         faixa_etaria = str_replace_all(faixa_etaria," a ","-"),
         faixa_etaria = str_replace_all(faixa_etaria,"  e mais","+")) %>%
  head(-1)

censo_2010 <- censo_2010 %>% 
  slice(1:20) %>% 
  mutate(faixa_etaria = cut(as.numeric(faixa_etaria), breaks = c(seq(from = 0, to = 20, by = 5)), 
                            right = FALSE, include.lowest = TRUE,
                            labels = c('0-4', '5-9', '10-14', '15-19'))) %>%
  group_by(faixa_etaria) %>% 
  summarise(Masculino = sum(Masculino),
            Feminino = sum(Feminino),
            Total = sum(Total)) %>%
  bind_rows(censo_2010 %>% slice(21:33)) #combinando a manipulacao feita antes com o restante do banco

tabua_masculina_2010 <- readxl::read_xls("C:/Users/jehhv/OneDrive/Documentos/UnB/2023/2023.1/Demografia_Ana Maria/Trabalho 2 - Projeção/tabuas_mortalidade.xls",
                                         range = "A9:I30", sheet = "SC") %>%
  select(Idade, nLx) %>%
  slice(2:21) 

tabua_feminina_2010 <- readxl::read_xls("C:/Users/jehhv/OneDrive/Documentos/UnB/2023/2023.1/Demografia_Ana Maria/Trabalho 2 - Projeção/tabuas_mortalidade.xls",
                                         range = "K9:S30", sheet = "SC") %>%
  select(Idade, nLx) %>%
  slice(2:21) 

get_nPx_n <- function(nLx_n, nLx, nPx){
  return((nLx_n/nLx)*nPx) # prob. de sobrevivencia no intervalo x+n --> x+n+m-1
}

```


```{r}

##############################
#### PROJEÇÃO 2010 - 2015 ####
##############################

## Masculino ##

projecao_masculina_2015 <- tabua_masculina_2010 %>% 
  select(Idade, nLx) %>%
  mutate(Idade = str_replace_all(Idade,"80|85|90","80+")) %>%
  slice(18:20) %>%
  group_by(Idade) %>% summarise(nLx = sum(nLx)) %>%
  bind_rows(tabua_masculina_2010 %>% slice(1:17) %>%
              mutate(Idade = as.character(Idade)),.)

projecao_masculina_2015 <- projecao_masculina_2015 %>%
  mutate(Idade = str_replace_all(Idade,"0|1","0")) %>%
  slice(1:2) %>%
  group_by(Idade) %>% summarise(nLx = sum(nLx)) %>%
  bind_rows(projecao_masculina_2015 %>% slice(3:18))

nPx_n_masculino <- c()

for (i in 1:(length(projecao_masculina_2015$Idade))-1) {
  nPx_n_masculino[i+1] <- (projecao_masculina_2015$nLx[i+1]/projecao_masculina_2015$nLx[i])*censo_2010$Masculino[i]
} # intervalo etário de x a x+n-1 anos completos

(nPx_n_masculino[17] <- (projecao_masculina_2015$nLx[17]/projecao_masculina_2015$nLx[16])*(censo_2010$Masculino[17]+censo_2010$Masculino[16]))

projecao_masculina_2015 %>%
  mutate(nPx_n = nPx_n_masculino)

## Feminino ## 

projecao_feminina_2015 <- tabua_feminina_2010 %>% 
  select(Idade, nLx) %>%
  mutate(Idade = str_replace_all(Idade,"80|85|90","80+")) %>%
  slice(18:20) %>%
  group_by(Idade) %>% summarise(nLx = sum(nLx)) %>%
  bind_rows(tabua_feminina_2010 %>% slice(1:17) %>%
              mutate(Idade = as.character(Idade)),.)

projecao_feminina_2015 <- projecao_feminina_2015 %>%
  mutate(Idade = str_replace_all(Idade,"0|1","0")) %>%
  slice(1:2) %>%
  group_by(Idade) %>% summarise(nLx = sum(nLx)) %>%
  bind_rows(projecao_feminina_2015 %>% slice(3:18))

nPx_n_feminino <- c()

for (i in 1:(length(projecao_feminina_2015$Idade))-1) {
  nPx_n_feminino[i+1] <- (projecao_feminina_2015$nLx[i+1]/projecao_feminina_2015$nLx[i])*censo_2010$Feminino[i]
}

#nPx_n_feminino[17] <- (projecao_feminina_2015$nLx[17]/(projecao_feminina_2015$nLx[16]+projecao_feminina_2015$nLx[17]))*(censo_2010$Feminino[17]+censo_2010$Feminino[16])

projecao_feminina_2015 %>%
  mutate(nPx_n = nPx_n_feminino)

```

```{r}

## Calculando numero total de nascimentos no quinquenio ##

projecao_2015 <- read_delim("~/UnB/2023/2023.1/Demografia_Ana Maria/Trabalho 2 - Projeção/projecao_2015.csv", 
                            delim = ";", escape_double = FALSE, trim_ws = TRUE)

projecao_2015 <- projecao_2015 %>% 
  rename(faixa_etaria = "Faixa Etária 1") %>%
  mutate(faixa_etaria = str_replace_all(faixa_etaria,"ano(s)?",""),
         faixa_etaria = str_replace_all(faixa_etaria," a ","-"),
         faixa_etaria = str_replace_all(faixa_etaria,"  e mais","+")) %>%
  head(-1)

projecao_2015 <- projecao_2015 %>% 
  slice(17:19) %>%
  mutate(faixa_etaria = str_replace_all(faixa_etaria,"80-84 ","80+"),
         faixa_etaria = str_replace_all(faixa_etaria,"85-89 ","80+"),
         faixa_etaria = str_replace_all(faixa_etaria,"90","80")
  ) %>%
  group_by(faixa_etaria) %>% 
  summarise(Masculino = sum(Masculino),
            Feminino = sum(Feminino),
            Total = sum(Total)) %>% 
  bind_rows(projecao_2015 %>% slice(1:16), .)

```

```{r}

## Taxa de fecundidade ##

# 2010 - 2015 #

df_2015 <- read_delim("~/UnB/2023/2023.1/Demografia_Ana Maria/Trabalho 2 - Projeção/projecao_2015.csv", 
                                       delim = ";", escape_double = FALSE, trim_ws = TRUE)


df_2015 <- df_2015 %>% 
  rename(faixa_etaria = "Faixa Etária 1") %>%
  mutate(faixa_etaria = str_replace_all(faixa_etaria,"ano(s)?",""),
         faixa_etaria = str_replace_all(faixa_etaria," a ","-"),
         faixa_etaria = str_replace_all(faixa_etaria,"  e mais","+"),
         faixa_etaria = str_trim(faixa_etaria)) %>%
  head(-1)

pop_feminina_2010 <- censo_2010$Feminino[4:10] #idade fertil
pop_feminina_2015 <- df_2015$Feminino[4:10]
pop_media_2010_2015 <-  bind_cols(pop_feminina_2010, pop_feminina_2015)

DNSC_2010 <- read.dbc("~/UnB/2023/2023.1/Demografia_Ana Maria/Trabalho 2 - Projeção/DNSC2010.dbc")

idade_fem <- DNSC_2010 %>% mutate(classes_idade = cut(as.numeric(IDADEMAE),
                                                      seq(0,100,5),
                                                      labels = NULL,
                                                      include.lowest = T,
                                                      right = F)) %>%
  select(IDADEMAE,classes_idade) %>% group_by(classes_idade) %>% 
  summarise(n = n())

fecundidade <- data.frame("GRUPO ETARIO" = c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49"),
                          freqnascfem = idade_fem$n[2:8]) # selecionando grupos de idades no período reprodutivo

f15 <- fecundidade %>% bind_cols(pop_media_2010_2015) %>%
  rename("total_2010"="...3","total_2015"="...4") %>%
  mutate(taxa_fecundidade = freqnascfem/total_2010,
         media=(total_2010+total_2015)/2,
         B_barra=taxa_fecundidade*media) 
#taxas especificas de fecundidade entre t e t+5
#numero medio de nascimentos anuais

```

```{r}
projecao_2015_0_4_anos <- (5*sum(f15$B_barra))*projecao_feminina_2015$nLx[1]/(5*100000)
projecao_2015_0_4_anos_masculino <- projecao_2015_0_4_anos*0.512275
projecao_2015_0_4_anos_feminino <- projecao_2015_0_4_anos*0.487725

projecao_feminina_2015 <- projecao_feminina_2015 %>%
  mutate(nPx_n = nPx_n_feminino)

projecao_feminina_2015$nPx_n[1] <- projecao_2015_0_4_anos_feminino

projecao_masculina_2015 <- projecao_masculina_2015 %>%
  mutate(nPx_n = nPx_n_masculino)

projecao_masculina_2015$nPx_n[1] <- projecao_2015_0_4_anos_masculino

projecao_2015_IBGE_feminino <- readxl::read_xls("./projecoes_2018_populacao_2010_2060_20200406.xls",
                                                range = "G29:G48", sheet = "SC")

projecao_2015_IBGE_masculino <- readxl::read_xls("./projecoes_2018_populacao_2010_2060_20200406.xls",
                                                 range = "G6:G25", sheet = "SC")


projecao_2015_IBGE_feminino <- projecao_2015_IBGE_feminino %>% 
  rename("Feminino_IBGE"=`3426676`)

projecao_2015_IBGE_feminino$Feminino_IBGE[17] <- sum(projecao_2015_IBGE_feminino$Feminino_IBGE[17],
                                                     projecao_2015_IBGE_feminino$Feminino_IBGE[18],
                                                     projecao_2015_IBGE_feminino$Feminino_IBGE[19]) # 80+

projecao_2015_IBGE_feminino <- projecao_2015_IBGE_feminino %>% slice(1:17) #juntar com demais faixas

projecao_2015_IBGE_masculino <- projecao_2015_IBGE_masculino %>% 
  rename("Masculino_IBGE"=`3375630`)

projecao_2015_IBGE_masculino$Masculino_IBGE[17] <- sum(projecao_2015_IBGE_masculino$Masculino_IBGE[17],
                                                       projecao_2015_IBGE_masculino$Masculino_IBGE[18],
                                                       projecao_2015_IBGE_masculino$Masculino_IBGE[19])

projecao_2015_IBGE_masculino <- projecao_2015_IBGE_masculino %>% slice(1:17)

projecao_feminina_2015 %>% bind_cols(censo_2010$faixa_etaria,projecao_2015_IBGE_masculino, projecao_masculina_2015, projecao_2015_IBGE_feminino) %>%
  rename("Faixa etária"="...4") %>% select(`Faixa etária`, nPx_n...3, Feminino_IBGE, nPx_n...8, Masculino_IBGE) %>%
  mutate(total_projecao_propria = nPx_n...3+nPx_n...8,
         total_IBGE = Feminino_IBGE+Masculino_IBGE) %>%
  kbl(caption="Projeção, segundo sexo. Santa Catarina - 1991, 2000, 2010, 2015, 2020 e 2030.",
      format= "latex",
      col.names = c("Faixa etária","Projeção Fem","Projeção IBGE fem", "Projeção Masc","Projeção IBGE masc","propria_total","propria_IBGE"),
      align="r") %>%
  kable_classic(full_width = F, html_font = "helvetica")
```

```{r}
##############################
#### PROJEÇÃO 2015 - 2020 ####
##############################

nLx_masculino_TP1 <- c(100285.699+388578.668, 483464.432, 482643.729,
                       483943.467, 477182.758, 464598.489, 454005.005,
                       442354.036, 430923.632,414554.745, 388840.564,
                       354334.568, 306371.676, 247629.000, 177397.209,
                       109011.183, 50891.787+14873.633+1021.977) 

# valores retirados das tabuas de vida do trabalho 1

nLx_feminino_TP1 <- c(100224.679+390328.758, 486448.771, 485406.688,
                      484579.019, 482320.324, 478696.588, 474774.797,
                      470094.589, 462963.732, 452199.198, 437547.092,
                      415282.668, 385109.201, 343464.885, 287852.122,
                      218361.179, 137413.451+61201.615+7446.397)

# valores retirados das tabuas de vida do trabalho 1
```


```{r}

df_2015 <- read_csv2("./projecao_2015.csv")

df_2015 <- df_2015 %>% 
  rename(faixa_etaria = "Faixa Etária 1") %>%
  mutate(faixa_etaria = str_replace_all(faixa_etaria,"ano(s)?",""),
         faixa_etaria = str_replace_all(faixa_etaria," a ","-"),
         faixa_etaria = str_replace_all(faixa_etaria,"  e mais","+")) %>%
  head(-1)

df_2015 <- df_2015 %>% 
  slice(17:19) %>%
  mutate(faixa_etaria = str_replace_all(faixa_etaria,"80-84 ","80+"),
         faixa_etaria = str_replace_all(faixa_etaria,"85-89 ","80+"),
         faixa_etaria = str_replace_all(faixa_etaria,"90","80")
  ) %>%
  group_by(faixa_etaria) %>% 
  summarise(Masculino = sum(Masculino),
            Feminino = sum(Feminino),
            Total = sum(Total)) %>% 
  bind_rows(df_2015 %>% slice(1:16), .) %>%
  mutate(faixa_etaria = str_trim(faixa_etaria))

Idade <- df_2015$faixa_etaria

df_2020 <- read_csv2("./projecao_2020.csv")

df_2020 <- df_2020 %>% 
  rename(faixa_etaria = "Faixa Etária 1") %>%
  mutate(faixa_etaria = str_replace_all(faixa_etaria,"ano(s)?",""),
         faixa_etaria = str_replace_all(faixa_etaria," a ","-"),
         faixa_etaria = str_replace_all(faixa_etaria,"  e mais","+")) %>%
  head(-1)

df_2020 <- df_2020 %>% 
  slice(17:19) %>%
  mutate(faixa_etaria = str_replace_all(faixa_etaria,"80-84 ","80+"),
         faixa_etaria = str_replace_all(faixa_etaria,"85-89 ","80+"),
         faixa_etaria = str_replace_all(faixa_etaria,"90","80")
  ) %>%
  group_by(faixa_etaria) %>% 
  summarise(Masculino = sum(Masculino),
            Feminino = sum(Feminino),
            Total = sum(Total)) %>% 
  bind_rows(df_2020 %>% slice(1:16), .)

pop_feminina_2015 <- df_2015$Feminino
pop_masculina_2015 <- df_2015$Masculino

pop_feminina_2015 <- df_2015$Feminino[4:10] #idade fertil
pop_feminina_2020 <- df_2020$Feminino[4:10]
pop_media_2020_2015 <-  bind_cols(pop_feminina_2020, pop_feminina_2015)

```


```{r}

#### Natalidade

DNSC_2015 <- read.dbc("./DNSC2015.dbc")

idade_fem <- DNSC_2015 %>% mutate(classes_idade = cut(as.numeric(IDADEMAE),
                                                      seq(0,100,5),
                                                      labels = NULL,
                                                      include.lowest = T,
                                                      right = F)) %>%
  select(IDADEMAE,classes_idade) %>% group_by(classes_idade) %>% summarise(n = n())

fecundidade <- data.frame("GRUPO ETARIO" = c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49"),freqnascfem = idade_fem$n[2:8])

f20 <- fecundidade %>% bind_cols(pop_media_2020_2015) %>%
  rename("total_2020"="...3","total_2015"="...4") %>%
  mutate(taxa_fecundidade = freqnascfem/total_2015,
         media=(total_2020+total_2015)/2,
         B_barra=taxa_fecundidade*media)
```

```{r}

## Masculino ##

projecao_masculina_2020 <- bind_cols(Idade, nLx_masculino_TP1) %>% 
  rename("Idade"="...1","nLx"="...2")

nPx_n_masculino_2020 <- c()

for (i in 1:(length(projecao_masculina_2020$Idade))-1) {
  nPx_n_masculino_2020[i+1] <- (projecao_masculina_2020$nLx[i+1]/projecao_masculina_2020$nLx[i])*(pop_masculina_2015[i])
}

projecao_masculina_2020 <- projecao_masculina_2020 %>%
  mutate(nPx_n = nPx_n_masculino_2020)

## Feminino ##

projecao_feminina_2020 <- bind_cols(Idade, nLx_feminino_TP1) %>% 
  rename("Idade"="...1","nLx"="...2")

nPx_n_feminino_2020 <- c()

for (i in 1:(length(projecao_feminina_2020$Idade))-1) {
  nPx_n_feminino_2020[i+1] <- (projecao_feminina_2020$nLx[i+1]/projecao_feminina_2020$nLx[i])*df_2015$Feminino[i]
}

projecao_feminina_2020 <- projecao_feminina_2020 %>%
  mutate(nPx_n = nPx_n_feminino_2020)

projecao_2020_0_4_anos <- (5*sum(f20$B_barra))*nLx_feminino_TP1[1]/(5*100000)
projecao_2020_0_4_anos_masculino <- projecao_2020_0_4_anos*0.5130885
projecao_2020_0_4_anos_feminino <- projecao_2020_0_4_anos*0.4868601

projecao_feminina_2020$nPx_n[1] <- projecao_2020_0_4_anos_feminino
projecao_masculina_2020$nPx_n[1] <- projecao_2020_0_4_anos_masculino

```

```{r}

# projecoes do IBGE 

#feminino 
projecao_2020_IBGE_feminino <- readxl::read_xls("./projecoes_2018_populacao_2010_2060_20200406.xls",
                                                range = "L29:L48", sheet = "SC")

projecao_2020_IBGE_masculino <- readxl::read_xls("./projecoes_2018_populacao_2010_2060_20200406.xls",
                                                 range = "L6:L25", sheet = "SC")

projecao_2020_IBGE_feminino <- projecao_2020_IBGE_feminino %>% 
  rename("Feminino_IBGE"=`3654387`)

projecao_2020_IBGE_feminino$Feminino_IBGE[17] <- sum(projecao_2020_IBGE_feminino$Feminino_IBGE[17],
                                                     projecao_2020_IBGE_feminino$Feminino_IBGE[18],
                                                     projecao_2020_IBGE_feminino$Feminino_IBGE[19])


projecao_2020_IBGE_feminino <- projecao_2020_IBGE_feminino %>% slice(1:17)

#masculino
projecao_2020_IBGE_masculino <- projecao_2020_IBGE_masculino %>% 
  rename("masculino_IBGE"=`3598115`)

projecao_2020_IBGE_masculino$masculino_IBGE[17] <- sum(projecao_2020_IBGE_masculino$masculino_IBGE[17],
                                                       projecao_2020_IBGE_masculino$masculino_IBGE[18],
                                                       projecao_2020_IBGE_masculino$masculino_IBGE[19])


projecao_2020_IBGE_masculino <- projecao_2020_IBGE_masculino %>% slice(1:17)

projecao_feminina_2020 %>% bind_cols(Idade,projecao_2020_IBGE_feminino, projecao_masculina_2020, projecao_2020_IBGE_masculino) %>%
  rename("Faixa etária"="...4") %>% select(`Faixa etária`, nPx_n...3, Feminino_IBGE, nPx_n...8, masculino_IBGE) %>%
  mutate(total_projecao_proprica = nPx_n...3+nPx_n...8,
         total_IBGE = Feminino_IBGE+masculino_IBGE) %>%
  kbl(caption="Projeção, segundo sexo. Santa Catarina - 1991, 2000, 2010, 2015, 2020 e 2030.",
      format= "latex",
      col.names = c("Faixa etária","Projeção Fem","Projeção IBGE fem", "Projeção Masc","Projeção IBGE masc","propria_total","propria_IBGE"),
      align="r") %>%
  kable_classic(full_width = F, html_font = "helvetica")

```

**c) No link https://www.ibge.gov.br/estatisticas/sociais/populacao/9109-projecao-da-populacao.html?=&t=downloads estão disponíveis as projeções da população por sexo e idade para o Brasil (2010-2060) e para as Unidades da Federação - revisão 2018, realizadas pelo IBGE.**

Com base nessas informações, construa e compare as pirâmides resultantes para os anos de 2010, 2020 e 2060 para o Brasil.

Compare os resultados da projeção para a UF escolhida realizada no item (b) e a publicada pelo IBGE.

* Para a análise dos resultados utilize indicadores de estrutura para respectivos anos (como os calculados na Parte 2 deste trabalho). Também comente  sobre os indicadores da dinâmica - taxa bruta de mortalidade, de natalidade e taxa de crescimento.
